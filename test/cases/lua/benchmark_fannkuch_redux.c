#include "test.lua.h"

TEST_F(lua, DISABLED_benchmark_fannkuch_redux)
{
    static const char* script =
"local function fannkuch(n)\n"
"  local p, q, s, sign, maxflips, sum = {}, {}, {}, 1, 0, 0\n"
"  for i=1,n do p[i] = i; q[i] = i; s[i] = i end\n"
"  repeat\n"
"    -- Copy and flip.\n"
"    local q1 = p[1]                -- Cache 1st element.\n"
"    if q1 ~= 1 then\n"
"      for i=2,n do q[i] = p[i] end     -- Work on a copy.\n"
"      local flips = 1\n"
"      repeat\n"
"   local qq = q[q1]\n"
"   if qq == 1 then             -- ... until 1st element is 1.\n"
"     sum = sum + sign*flips\n"
"     if flips > maxflips then maxflips = flips end -- New maximum?\n"
"     break\n"
"   end\n"
"   q[q1] = q1\n"
"   if q1 >= 4 then\n"
"     local i, j = 2, q1 - 1\n"
"     repeat q[i], q[j] = q[j], q[i]; i = i + 1; j = j - 1; until i >= j\n"
"   end\n"
"   q1 = qq; flips = flips + 1\n"
"      until false\n"
"    end\n"
"    -- Permute.\n"
"    if sign == 1 then\n"
"      p[2], p[1] = p[1], p[2]; sign = -1   -- Rotate 1<-2.\n"
"    else\n"
"      p[2], p[3] = p[3], p[2]; sign = 1        -- Rotate 1<-2 and 1<-2<-3.\n"
"      for i=3,n do\n"
"   local sx = s[i]\n"
"   if sx ~= 1 then s[i] = sx-1; break end\n"
"   if i == n then return sum, maxflips end -- Out of permutations.\n"
"   s[i] = i\n"
"   -- Rotate 1<-...<-i+1.\n"
"   local t = p[1]; for j=1,i do p[j] = p[j+1] end; p[i+1] = t\n"
"      end\n"
"    end\n"
"  until false\n"
"end\n"
"local n = tonumber(arg and arg[1]) or 1\n"
"local sum, flips = fannkuch(n)\n"
"io.write(sum, \"\\nPfannkuchen(\", n, \") = \", flips, \"\\n\")";

    TEST_CALL_LUA(script, "12");
}
